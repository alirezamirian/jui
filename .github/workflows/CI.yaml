name: CI pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  IS_PR_WITH_PERCY: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.title, 'no-percy') }}
  IS_PR_MERGED: ${{ github.ref_name == 'master' && contains(github.event.head_commit.message, 'Merge pull request') && !contains(github.event.head_commit.message, 'no-percy') }}

jobs:
  build:

    runs-on: ubuntu-latest # note: macos doesn't have docker installed!
    container: cypress/browsers:node14.17.0-chrome91-ff89

    steps:
    - name: Log Interesting Info ‚ÑπÔ∏è
      run: |
       echo "The job is triggered by a ${{ github.event_name }} event."
       echo "This job is now running on a ${{ runner.os }} server hosted by GitHub!"

    - name: Checkout üõéÔ∏è
      uses: actions/checkout@v2.3.1

    - name: Install Dependencies üîß
      run: yarn

    - name: Run Tests ‚úÖ
      if: ${{ env.IS_PR_MERGED == 'true' || env.IS_PR_WITH_PERCY == 'true' }}
      env:
        PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
        CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
      run: yarn workspaces run test

    - name: Run Tests (without percy) ‚úÖ
      if: ${{ !(env.IS_PR_MERGED == 'true' || env.IS_PR_WITH_PERCY == 'true') }}
      env:
        CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
      run: yarn workspaces run test

    - uses: actions/upload-artifact@v2
      name: Upload Cypress screenshots if tests failed ü§ï
      if: failure()
      with:
        name: cypress-screenshots
        path: |
          packages/jui/**/__image_snapshots__
          packages/jui/cypress/videos
          packages/jui/cypress/screenshots
